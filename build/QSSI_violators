#!/bin/sh

# This script parses the ninja file and finds all QSSI violators if no component name is given; else finds violators based on component related string given as argument.
# Run the script from the root directory of your workspace.
# To know the usage, type ./QSSI_violators --help

QSSI_WHITELIST_FILE="$QCPATH/release/QSSI/QSSI_whitelist.txt"
QSSI_ENFORCED_FILE="$QCPATH/release/QSSI/QSSI_enforced_projects.txt"
QSSI_VIOLATORS_OUTPUT_FILE="$OUT/QSSI_violators.txt"

ninja_split()
{
  rm -f $3
  cat $2 | awk -v pstr=$1 '
    BEGIN {c=0;m=0;i=0;mstr="";istr="";
           if (match(pstr, "host")) {pmatch="out/";}
           else {pmatch="out/target/product/([[:alnum:]]|_)+/";}
          }
    /^ command = / {c=1;mstr="";istr="";}
    /--makefile /  {if (c==1) {
                      idx=match($0, "--makefile ([[:graph:]]+)");
                      if (idx) {mstr=substr($0, RSTART+11, RLENGTH-11);m=1;}
                    }
                   }
    /Install: /    {if (m==1) {
                      idx=match($0, "Install: ([[:graph:]]+)");
                      if (idx) istr=substr($0, RSTART+9, RLENGTH-9);
                      idx=match(istr, pmatch pstr);
                      if (idx && (mstr!="")) {print mstr " " istr;}
                    }
                    c=0;m=0;
                   }
  ' > $3.tmp

  cat $2 | grep "rspfile_content" | grep '"class":' | sed 's#\\n#\n#g' | awk -v pstr=$1 '
    BEGIN {c=0;m=0;i=0;mstr="";istr="";
           if (match(pstr, "host")) {pmatch="out/";}
           else {pmatch="out/target/product/([[:alnum:]]|_)+/";}
          }
    /"class": \[/       {c=1;mstr="";istr="";}
    /"path": \[/        {if (c==1) {
                         idx=match($0, "[[:punct:]]path[[:punct:]]: [[[:punct:]]([[:graph:]]+)");
                         if (idx) {mstr=substr($0, RSTART+10, RLENGTH-12);m=1;}
                         }
                        }
    /"installed": \[/   {if (m==1) {
                         idx=match($0, "[[:punct:]]installed[[:punct:]]: [[[:punct:]]([^]]+)");
                         if (idx) {istr=substr($0, RSTART+14, RLENGTH-16);m=1;}
                         idx=match(istr, pmatch pstr);
                         if (idx && (mstr!="")) {gsub(","," ",istr);gsub("\"","",istr);split(istr,iarr," ");
                           for (x in iarr) {print mstr " " iarr[x];}}
                         }
                         c=0;m=0;
                        }
  ' >> $3.tmp

  cat $3.tmp | sort | egrep -v "^out\/soong\/" > $3

  if [ ! "$2" == "host" ]; then
    mv $3 $3.tmp
    cat $3.tmp | grep -v " out\/host\/" > $3
  fi
  rm -f $3.tmp
}

if [ "$#" -eq 0 ]; then
    echo "No ninja file name mentioned"
    exit 0
fi

while test $# -gt 0; do
    case "$1" in
        -h|--help)
        printf "\nusage : ./QSSI_violators <ninja file path>\n\n"
        echo "        Example : ./QSSI_violators out/build-sdm845.ninja"
        printf "        -> for getting the list of violators based on QSSI_enforced_projects.txt and QSSI_whitelist.txt\n"
        printf "\n\n        ./QSSI_violators <ninja file path> <component name string to grep>\n\n"
        echo "        Example : ./QSSI_violators out/build-sdm845.ninja gfx or ./QSSI_violators out/build-sdm845.ninja display.lnx"
        printf "        -> for getting the list of violators for the component corresponding to the component string\n\n"
        exit 0
        ;;
        *)
        break
        ;;
    esac
done

if [ ! -f $QSSI_ENFORCED_FILE ] | [ ! -f $QSSI_WHITELIST_FILE ] ; then
    echo 'QSSI: not enforced for this target'
    exit 0
fi

# Generate the ninja-split files if they do not exist
if [ ! -f $OUT/qssi-system.txt ]; then
    ninja_split system $1 $OUT/qssi-system.txt
fi
if [ ! -f $OUT/qssi-vendor.txt ]; then
    ninja_split vendor $1 $OUT/qssi-vendor.txt
fi
if [ ! -f $OUT/qssi-root.txt ]; then
    ninja_split root $1 $OUT/qssi-root.txt
fi


# Search for violators based on QSSI_enforced_projects.txt and QSSI_whitelist.txt or based on component-name
if [ "$#" -eq 1 ]; then
    printf "\nQSSI: Finding QSSI violators based on QSSI_whitelist.txt and QSSI_enforced_projects.txt...\n"

    awk 'ARGV[1] == FILENAME{a[$0];next} {for (i in a) {if(match($1,i)) print $0}}' $QSSI_ENFORCED_FILE $OUT/qssi-system.txt | awk '!x[$0]++' > violators.tmp
    awk 'ARGV[1] == FILENAME{a[$0];next} {for (i in a) {if(i == $0){c++}} if (c==0) {c=1; print $0} c=0;}' $QSSI_WHITELIST_FILE violators.tmp | awk '!x[$0]++' > $QSSI_VIOLATORS_OUTPUT_FILE

    if [ ! -s $QSSI_VIOLATORS_OUTPUT_FILE ]; then
        printf "\nQSSI: no QSSI violators found !\n\n"
    else
        printf "\nQSSI: violators are:\n"
        printf "Start-->\n"
        cat $QSSI_VIOLATORS_OUTPUT_FILE
        printf "<--End\n\n"
        printf "QSSI: violators also written to %s\n\n" "$QSSI_VIOLATORS_OUTPUT_FILE"
    fi
else
    printf "\n\nFinding QSSI violators ...\n\n"
    awk '!x[$0]++' violators.txt | tee $2.txt && printf "\n\n"
    if [ ! -s $2.txt ]; then
        printf "\nNo QSSI violators found !\n\n"
    else
        printf "QSSI violators written to %s.txt\n\n" "$2"
    fi
    rm violators.txt
fi

rm -f *.tmp
